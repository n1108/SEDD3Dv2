# configs/config_multi_resolution.yaml
defaults:
  - _self_
  - model: unified_small # 指向下面定义的模型配置文件
  - override hydra/launcher: submitit_slurm # 或者您常用的启动器

ngpus: 4
tokens: 11 # 假设类别数固定

# training 部分定义通用的训练参数
training:
  accum: 3 # <--- 全局梯度累积步数 (累积多少个微批次后进行一次优化器更新)
  n_total_iters: 2000000 # <--- 总的优化器步骤数
  snapshot_freq: 5000
  log_freq: 100 # <--- 日志记录频率 (按优化器步骤)
  eval_freq: 1000 # <--- 评估频率 (按优化器步骤)
  snapshot_freq_for_preemption: 1000
  weight: standard
  snapshot_sampling: True
  ema: 0.9999
  sampling_stage_idx: -1 # 用于快照采样时，选择哪个stage进行采样，-1表示最后一个

# data 部分现在包含一个 stages 列表
data:
  dataset: carla # 或 kitti360，假设数据集类型在所有阶段一致
  data_argumentation: true
  infer_data_source: 'dataset' # 默认值
  
  # 定义不同的训练阶段/分辨率
  stages:
    - name: "res_32_to_64"
      prev_stage: 's_1.5' 
      next_stage: 's_2.5'
      prev_data_size: [32, 32, 2]  
      image_size: [64, 64, 4]      # 当前阶段训练的目标图像尺寸 (H, W, U)
      batch_size: 8                # <--- 此阶段的单GPU微批次大小
      train_data_path: '/data/yutao_niu/pdd_data/CarlaSC_quantized_64_64_4/Cartesian/Train'
      quantized_train_data_path: '/data/yutao_niu/pdd_data/CarlaSC_quantized_32_32_2/Cartesian/Train' 
      valid_data_path: '/data/yutao_niu/pdd_data/CarlaSC_quantized_64_64_4/Cartesian/Val'
      quantized_valid_data_path: '/data/yutao_niu/pdd_data/CarlaSC_quantized_32_32_2/Cartesian/Val'
      eval_batch_size: 8 # <--- (可选) 此阶段评估时的单GPU批大小，若无则用训练的 batch_size

    - name: "res_64_to_128"
      prev_stage: 's_2.5'
      next_stage: 's_3.5'
      prev_data_size: [64, 64, 4]
      image_size: [128, 128, 8]
      batch_size: 4 # <--- 此阶段的单GPU微批次大小
      train_data_path: '/data/yutao_niu/pdd_data/CarlaSC_quantized_128_128_8/Cartesian/Train'
      quantized_train_data_path: '/data/yutao_niu/pdd_data/CarlaSC_quantized_64_64_4/Cartesian/Train'
      valid_data_path: '/data/yutao_niu/pdd_data/CarlaSC_quantized_128_128_8/Cartesian/Val'
      quantized_valid_data_path: '/data/yutao_niu/pdd_data/CarlaSC_quantized_64_64_4/Cartesian/Val'
      eval_batch_size: 4

    - name: "res_128_to_256"
      prev_stage: 's_3.5'
      next_stage: 's_3'
      prev_data_size: [128, 128, 8]
      image_size: [256, 256, 16]
      batch_size: 1 # 分辨率更高，batch_size进一步减小
      train_data_path: '/data/yutao_niu/pdd_data/CarlaSC_quantized_256_256_16/Cartesian/Train'
      quantized_train_data_path: '/data/yutao_niu/pdd_data/CarlaSC_quantized_128_128_8/Cartesian/Train'
      valid_data_path: '/data/yutao_niu/pdd_data/CarlaSC_quantized_256_256_16/Cartesian/Val'
      quantized_valid_data_path: '/data/yutao_niu/pdd_data/CarlaSC_quantized_128_128_8/Cartesian/Val'
      eval_batch_size: 1

  prev_scene_path: ''
  infer_data_path: ''
  quantized_infer_data_path: ''

graph:
  type: absorb_relay
  file: data
  report_all: False

noise:
  type: loglinear
  sigma_min: 1e-4
  sigma_max: 20

sampling: 
  predictor: euler
  steps: 128
  noise_removal: True

eval:
  perplexity: True
  perplexity_batch_size: 32

optim:
  weight_decay: 0
  optimizer: AdamW
  lr: 3e-4
  beta1: 0.9
  beta2: 0.999
  eps: 1e-8
  warmup: 10000 
  grad_clip: 1.

hydra:
  run:
    # dir: exp_outputs/multires_${data.dataset}_${model.name}/${now:%Y.%m.%d}/${now:%H%M%S}
    # dir: exp_outputs/multires_carla_unified_small_multires/2025.05.31/191622
    dir: exp_outputs/multires_carla_unified_small_multires/2025.05.31/170817
  sweep:
    # dir: exp_outputs/multires_${data.dataset}_${model.name}/${now:%Y.%m.%d}/${now:%H%M%S}
    # dir: exp_outputs/multires_carla_unified_small_multires/2025.05.31/191622
    dir: exp_outputs/multires_carla_unified_small_multires/2025.05.31/170817
    subdir: ${hydra.job.num}
  launcher: 
    max_num_timeout: 100000
    partition: g40x
    account: stanford
    mem_gb: 96
    cpus_per_task: 40
    gpus_per_node: ${ngpus}
    constraint: null
